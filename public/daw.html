<!DOCTYPE html>
<html lang="en" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertible - DAW Projects</title>
    <link href="/css/output.css" rel="stylesheet">
</head>
<body class="min-h-screen bg-base-200">
    <div class="fixed top-4 right-4 z-50">
        <div class="dropdown dropdown-end">
            <label tabindex="0" class="btn btn-circle btn-ghost">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                </svg>
            </label>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                <li><a onclick="setTheme('light')">Light</a></li>
                <li><a onclick="setTheme('dark')">Dark</a></li>
                <li><a onclick="setTheme('cupcake')">Cupcake</a></li>
                <li><a onclick="setTheme('cyberpunk')">Cyberpunk</a></li>
                <li><a onclick="setTheme('forest')">Forest</a></li>
                <li><a onclick="setTheme('neon')">Neon</a></li>
            </ul>
        </div>
    </div>

    <!-- Header -->
    <div class="header-gradient text-white py-8 mb-8">
        <div class="container mx-auto px-4">
            <h1 class="text-4xl md:text-5xl font-bold text-center">
                Convertible
            </h1>
            <p class="text-center mt-2 opacity-90">
                Convert any file format
            </p>
            <div class="flex justify-center mt-4">
                <div class="dropdown">
                    <label tabindex="0" class="btn btn-wide m-1">
                        <span>DAW Project Converter</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </label>
                    <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                        <li><a href="/">Image Converter</a></li>
                        <li><a href="/audio.html">Audio Converter</a></li>
                        <li><a href="/daw.html">DAW Project Converter</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4">
        <div class="max-w-3xl mx-auto">
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <form id="uploadForm">
                        <!-- File Upload Area -->
                        <div class="form-control">
                            <input type="file" id="project" class="hidden" multiple accept=".als,.flp,.logicx,.ptx,.rpp,.sesx,.zip" />
                            <div id="filePreview" class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center cursor-pointer transition-colors duration-200">
                                <div id="dropMessage" class="flex flex-col items-center justify-center gap-4">
                                    <div class="text-4xl text-primary">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-semibold text-lg">Drag & Drop your DAW project files here</h3>
                                        <p class="text-sm opacity-70 mt-1">or click to browse</p>
                                    </div>
                                    <div class="text-xs opacity-50">
                                        Supported formats: Ableton Live, FL Studio, Logic Pro, Pro Tools, REAPER, Studio One
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conversion Options -->
                        <div id="conversionOptions" class="hidden mt-6 space-y-4">
                            <!-- Format Selection -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Output Format</span>
                                </label>
                                <select id="format" class="select select-bordered w-full">
                                    <option value="als">Ableton Live (.als)</option>
                                    <option value="flp">FL Studio (.flp)</option>
                                    <option value="logicx">Logic Pro (.logicx)</option>
                                    <option value="ptx">Pro Tools (.ptx)</option>
                                    <option value="rpp">REAPER (.rpp)</option>
                                    <option value="sesx">Studio One (.sesx)</option>
                                </select>
                            </div>

                            <!-- Export Options -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text">Export Options</span>
                                </label>
                                <div class="space-y-2">
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="checkbox" name="exportAudio" checked />
                                        <span>Include Audio Files</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="checkbox" name="exportMIDI" checked />
                                        <span>Include MIDI Data</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="checkbox" class="checkbox" name="exportAutomation" checked />
                                        <span>Include Automation</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-full">Convert Project</button>
                    </form>

                    <!-- Loading State -->
                    <div id="loading" class="hidden">
                        <div class="flex justify-center items-center gap-2">
                            <span class="loading loading-spinner"></span>
                            <span>Converting project...</span>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="result" class="mt-6 space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/daw-converter.js"></script>
    <script type="module">
        // Import Tauri event listener
        import { listen } from '@tauri-apps/api/event';

        const fileInput = document.getElementById('project');
        const filePreview = document.getElementById('filePreview');
        const uploadForm = document.getElementById('uploadForm');
        const loading = document.getElementById('loading');
        const result = document.getElementById('result');
        const dropMessage = document.getElementById('dropMessage');

        // Initialize drag and drop
        async function initDragAndDrop() {
            // Check if we're running in Tauri
            const isTauri = window.__TAURI__ !== undefined;
            console.log('Running in Tauri:', isTauri);

            if (isTauri) {
                try {
                    // Tauri-specific file drop handling
                    await listen('tauri://file-drop', event => {
                        console.log('File dropped:', event);
                        const paths = event.payload;
                        const files = paths.map(path => {
                            const name = path.split('\\').pop() || path.split('/').pop();
                            return new File([''], name, {
                                path: path,
                                type: 'application/octet-stream'
                            });
                        });
                        handleFiles(files);
                    });

                    await listen('tauri://file-drop-hover', () => {
                        console.log('File hover');
                        highlight();
                    });

                    await listen('tauri://drop-cancelled', () => {
                        console.log('Drop cancelled');
                        unhighlight();
                    });

                    console.log('Tauri file drop listeners initialized');
                } catch (error) {
                    console.error('Error setting up Tauri file drop:', error);
                }
            }

            // Always set up browser events as fallback
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                document.body.addEventListener(eventName, preventDefaults, false);
                filePreview.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            // Handle drop zone highlighting
            ['dragenter', 'dragover'].forEach(eventName => {
                filePreview.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                filePreview.addEventListener(eventName, unhighlight, false);
            });

            // Handle dropped files for browser
            filePreview.addEventListener('drop', handleDrop, false);

            // Common event listeners
            fileInput.addEventListener('change', handleFileSelect, false);
            filePreview.addEventListener('click', (e) => {
                if (!e.target.closest('button') && 
                    (e.target.closest('#dropMessage') || e.target === filePreview)) {
                    fileInput.click();
                }
            });
        }

        function highlight() {
            filePreview.classList.add('border-primary', 'bg-base-200', 'border-opacity-50');
        }

        function unhighlight() {
            filePreview.classList.remove('border-primary', 'bg-base-200', 'border-opacity-50');
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            if (files && files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            if (!files || files.length === 0) return;

            // Show conversion options
            document.getElementById('conversionOptions').classList.remove('hidden');
            dropMessage.style.display = 'none';

            // Clear existing previews
            const previews = filePreview.querySelectorAll('.preview-card');
            previews.forEach(preview => preview.remove());

            // Add new previews
            Array.from(files).forEach(file => {
                const previewCard = document.createElement('div');
                previewCard.className = 'preview-card card bg-base-100 shadow-sm mb-4';
                previewCard.innerHTML = `
                    <div class="card-body p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="card-title text-sm flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                    </svg>
                                    ${file.name}
                                </h3>
                                <p class="text-xs opacity-70 mt-1">${formatFileSize(file.size)}</p>
                            </div>
                            <button type="button" class="btn btn-ghost btn-sm btn-circle" onclick="removeFile(this)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                filePreview.appendChild(previewCard);
            });

            // Update file input
            const dataTransfer = new DataTransfer();
            Array.from(files).forEach(file => dataTransfer.items.add(file));
            fileInput.files = dataTransfer.files;
        }

        function removeFile(button) {
            const card = button.closest('.preview-card');
            card.remove();

            // Clear the file input
            fileInput.value = '';

            // If no more previews, show drop message and hide options
            const previews = filePreview.querySelectorAll('.preview-card');
            if (previews.length === 0) {
                document.getElementById('conversionOptions').classList.add('hidden');
                dropMessage.style.display = 'flex';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Theme handling
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'cupcake';
        setTheme(savedTheme);

        // Initialize drag and drop when the page loads
        initDragAndDrop();

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const files = fileInput.files;
                if (!files || files.length === 0) {
                    throw new Error('Please select at least one file to convert');
                }

                const format = document.getElementById('format').value;
                const options = {
                    exportAudio: document.querySelector('[name="exportAudio"]').checked,
                    exportMIDI: document.querySelector('[name="exportMIDI"]').checked,
                    exportAutomation: document.querySelector('[name="exportAutomation"]').checked
                };

                loading.classList.remove('hidden');
                const submitButton = e.target.querySelector('button[type="submit"]');
                submitButton.disabled = true;
                submitButton.innerHTML = `
                    <span class="loading loading-spinner loading-sm"></span>
                    Converting...
                `;

                // Convert each file
                const results = [];
                for (const file of files) {
                    const convertedFile = await window.dawConverter.convertProject(file, format, options);
                    results.push(convertedFile);
                }

                // Display results
                result.innerHTML = `
                    <div class="alert alert-success shadow-lg mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <h3 class="font-bold">Success!</h3>
                            <div class="text-xs">Successfully converted ${results.length} file(s)</div>
                        </div>
                    </div>
                    <div class="divider">DOWNLOADS</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        ${results.map(file => `
                            <div class="card bg-base-100 shadow-lg hover:shadow-xl transition-shadow duration-200">
                                <div class="card-body">
                                    <div class="flex items-start justify-between">
                                        <div>
                                            <h3 class="card-title text-sm flex items-center gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                                                </svg>
                                                ${file.filename}
                                            </h3>
                                            <div class="mt-2 space-y-1">
                                                <p class="text-xs opacity-70 flex items-center gap-2">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                                                    </svg>
                                                    Original: ${file.originalName}
                                                </p>
                                                <div class="flex items-center gap-4">
                                                    <p class="text-xs opacity-70 flex items-center gap-2">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                                                        </svg>
                                                        Before: ${formatFileSize(file.originalSize)}
                                                    </p>
                                                    <p class="text-xs opacity-70 flex items-center gap-2">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
                                                        </svg>
                                                        After: ${formatFileSize(file.size)}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex flex-col items-end gap-2">
                                            <div class="badge badge-primary">${file.filename.split('.').pop().toUpperCase()}</div>
                                            <a href="${file.data}" 
                                               download="${file.filename}" 
                                               class="btn btn-primary btn-sm gap-2">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                                </svg>
                                                Download
                                            </a>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <div class="flex justify-between text-xs opacity-70">
                                            <span>Compression</span>
                                            <span>${Math.round((1 - file.size / file.originalSize) * 100)}% smaller</span>
                                        </div>
                                        <progress class="progress progress-primary w-full" 
                                                value="${file.size}" 
                                                max="${file.originalSize}"></progress>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-center mt-6">
                        <button onclick="downloadAll()" class="btn btn-primary gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Download All
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error('Conversion error:', error);
                result.innerHTML = `
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>Error: ${error.message}</span>
                    </div>
                `;
            } finally {
                loading.classList.add('hidden');
                submitButton.disabled = false;
                submitButton.textContent = 'Convert Project';
            }
        });
    </script>
</body>
</html> 